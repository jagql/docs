(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{176:function(s,a,t){"use strict";t.r(a);var e=t(0),n=Object(e.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("div",{staticClass:"content"},[t("h1",{attrs:{id:"relationships"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#relationships","aria-hidden":"true"}},[s._v("#")]),s._v(" Relationships")]),s._v(" "),t("h3",{attrs:{id:"foreign-key-relations"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#foreign-key-relations","aria-hidden":"true"}},[s._v("#")]),s._v(" Foreign Key Relations")]),s._v(" "),t("p",[s._v("We want to be able to back our resources in any datastore we like, in any system we like. This means we can't rely on any database layer relationships to join resources.")]),s._v(" "),t("h4",{attrs:{id:"problem-supporting-back-links"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#problem-supporting-back-links","aria-hidden":"true"}},[s._v("#")]),s._v(" Problem: supporting back-links")]),s._v(" "),t("p",[s._v("In other words, each resource would maintain its own linkage.")]),s._v(" "),t("p",[s._v("Consider these resources:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('Bookings have people:\n  "HPABCDE": {\n    owner: "Dave"\n  }\n\nPeople have Bookings:\n  "Dave": {\n    bookings: [ "HPABCDE" ]\n  }\n  "Fred": {\n    bookings: [ ]\n  }\n')])])]),t("p",[s._v('If I were to update the owner of HPABCDE to "Fred":\nPATCH -> /bookings/HPABCDE/relationships/owner\nthen the dataset would look like this:')]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('Bookings have people:\n  "HPABCDE": {\n    owner: "Fred"\n  }\n\nPeople have Bookings:\n  "Dave": {\n    bookings: [ "HPABCDE" ]\n  }\n  "Fred": {\n    bookings: [ ]\n  }\n')])])]),t("p",[s._v("Notice the reverse linkage between bookings and people is now broken. We could get around this by automatically forcing other update requests:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("PATCH -> /bookings/HPABCDE/relationships/owner\n---- becomes\nPATCH -> /bookings/HPABCDE/relationships/owner\nPATCH -> /people/Dave/relationships/bookings\nPATCH -> /people/Fred/relationships/bookings\n")])])]),t("p",[s._v("All 3x requests combined will produce the desired end linkage:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('Bookings have people:\n  "HPABCDE": {\n    owner: "Dave"\n  }\n\nPeople have Bookings:\n  "Dave": {\n    bookings: [ ]\n  }\n  "Fred": {\n    bookings: [ "HPABCDE" ]\n  }\n')])])]),t("p",[s._v("The number of requests vary on the relationship (1-1, 1-many, many-many, many-1).")]),s._v(" "),t("p",[s._v("Consider now if one of the 3 updates fails - we need to rollback the other 2. We now have to do all of this:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("PATCH -> /bookings/HPABCDE/relationships/owner\n---- becomes\nGET -> /bookings/HPABCDE/relationships/owner\nGET -> /people/Dave/relationships/bookings\nGET -> /people/Fred/relationships/bookings\nPATCH -> /bookings/HPABCDE/relationships/owner\nPATCH -> /people/Dave/relationships/bookings\nPATCH -> /people/Fred/relationships/bookings\n[if one fails...]\nPATCH -> /bookings/HPABCDE/relationships/owner\nPATCH -> /people/Dave/relationships/bookings\n")])])]),t("p",[s._v('There\'s also now a racehazard whereby two people try to update the same resource and mess up the relations. This is solvable by passing in a checksum to the PATCH requests, allowing us to identify if a resource has been remotely modified. The checksum would need to be returned as a part of the JSON:API formatted response, alongside "id" and "type".')]),s._v(" "),t("p",[s._v("In a nutshell - all of the above is a terrible idea.")]),s._v(" "),t("h4",{attrs:{id:"solution-we-only-support-forward-links"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#solution-we-only-support-forward-links","aria-hidden":"true"}},[s._v("#")]),s._v(" Solution: we only support forward-links")]),s._v(" "),t("p",[s._v("This:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('Bookings have people:\n  "HPABCDE": {\n    owner: "Dave"\n  }\n\nPeople have Bookings:\n  "Dave": {\n    bookings: [ ]\n  }\n  "Fred": {\n    bookings: [ "HPABCDE" ]\n  }\n')])])]),t("p",[s._v("becomes:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('Bookings have people:\n  "HPABCDE": {\n    owner: "Dave"\n  }\n\nPeople don\'t know about their Bookings:\n  "Dave": {\n\n  }\n  "Fred": {\n\n  }\n')])])]),t("p",[s._v("HOWEVER, we still want to maintain the reverse linkage, so we'll still offer up a linkage like this:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("/rest/people/26aa8a92-2845-4e40-999f-1fa006ec8c63/bookings\n")])])]),t("p",[s._v("although under the hood, we'll re-map it to something like this:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("/rest/bookings/relationships/?customer=26aa8a92-2845-4e40-999f-1fa006ec8c63\n")])])]),t("p",[s._v("and query for "),t("code",[s._v("bookings")]),s._v(" where "),t("code",[s._v("customer=?")]),s._v(".")]),s._v(" "),t("p",[s._v("The main gotcha here is this in this situation:")]),s._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("  Bookings maintain links to People\n  People maintain links to Trips\n  Trips maintain links to Bookings\n")])])]),t("p",[s._v("Looking up a person creates a reverse lookup against Bookings, creating a reverse lookup against Trips, causing a reverse lookup against People, creating a reverse lookup against....")]),s._v(" "),t("p",[s._v("Our solution here is to add "),t("code",[s._v("meta")]),s._v(" blocks to relationships to inform the consumer what kind of linkage they are looking at, and to not provide foreign keys directly:")]),s._v(" "),t("div",{staticClass:"language-json extra-class"},[t("pre",{pre:!0,attrs:{class:"language-json"}},[t("code",[s._v("relationships"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  author"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    meta"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      relation"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"primary"')]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      readOnly"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    links"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      // get information about the linkage - list of ids and types\n      self"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"http://localhost:16006/rest/comments/6b017640-827c-4d50-8dcc-79d766abb408/relationships/author"')]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      // get full details of all linked resources\n      related"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"http://localhost:16006/rest/comments/6b017640-827c-4d50-8dcc-79d766abb408/author"')]),s._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    data"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      type"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"people"')]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      id"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"ad3aa89e-9c5b-4ac9-a652-6670f9f27587"')]),s._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  article"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    meta"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      relation"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"foreign"')]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      belongsTo"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"articles"')]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      as"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"author"')]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      readOnly"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token boolean"}},[s._v("true")]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      many"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    links"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      // get information about the linkage - list of ids and types\n      self"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"http://localhost:16006/rest/articles/relationships/?comments=6b017640-827c-4d50-8dcc-79d766abb408"')]),t("span",{attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n      // get full details of all linked resources (perform a search against the foreign key"),t("span",{attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      related"),t("span",{attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{attrs:{class:"token string"}},[s._v('"http://localhost:16006/rest/articles/?filter[comments]=6b017640-827c-4d50-8dcc-79d766abb408"')]),s._v("\n    "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])])])}],!1,null,null,null);n.options.__file="relationships.md";a.default=n.exports}}]);