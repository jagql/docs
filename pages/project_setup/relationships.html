<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Relationships | jagql</title>
    <meta name="description" content="A resource driven NodeJS framework to set up a {json:api} + GraphQL endpoint in record time.">
    
    
    <link rel="preload" href="/assets/css/0.styles.cb5f6a57.css" as="style"><link rel="preload" href="/assets/js/app.1082b650.js" as="script"><link rel="preload" href="/assets/js/16.a88f0362.js" as="script"><link rel="prefetch" href="/assets/js/7.104f0666.js"><link rel="prefetch" href="/assets/js/2.9559f1fe.js"><link rel="prefetch" href="/assets/js/3.cc8a5dcd.js"><link rel="prefetch" href="/assets/js/4.6c0327fe.js"><link rel="prefetch" href="/assets/js/5.b7f61dc5.js"><link rel="prefetch" href="/assets/js/6.828d006e.js"><link rel="prefetch" href="/assets/js/8.1ca11d57.js"><link rel="prefetch" href="/assets/js/9.86a50049.js"><link rel="prefetch" href="/assets/js/10.57015bda.js"><link rel="prefetch" href="/assets/js/11.f77b854d.js"><link rel="prefetch" href="/assets/js/12.7480b5ec.js"><link rel="prefetch" href="/assets/js/13.b5dc4d39.js"><link rel="prefetch" href="/assets/js/14.1fa6b113.js"><link rel="prefetch" href="/assets/js/15.8ec93694.js"><link rel="prefetch" href="/assets/js/17.5dfc139c.js"><link rel="prefetch" href="/assets/js/18.a32709ca.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cb5f6a57.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      jagql
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/pages/" class="nav-link router-link-active">Guide</a></div><a href="https://github.com/jagql/framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pages/" class="nav-link router-link-active">Guide</a></div><a href="https://github.com/jagql/framework" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/pages/" class="sidebar-link">Introduction</a></li><li><a href="/pages/getting-started.html" class="sidebar-link">Getting Started</a></li><li><a href="/pages/configuration.html" class="sidebar-link">Configuration</a></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>Project Setup</span><!----></p><ul class="sidebar-group-items"><li><a href="/pages/project_setup/resources.html" class="sidebar-link">Resources</a></li><li><a href="/pages/project_setup/relationships.html" class="active sidebar-link">Relationships</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/project_setup/handlers.html" class="sidebar-link">Handlers</a></li><li><a href="/pages/project_setup/chain_handlers.html" class="sidebar-link">Chain Handlers</a></li><li><a href="/pages/project_setup/query_filter.html" class="sidebar-link">Query and Filter</a></li><li><a href="/pages/project_setup/suggested_structure.html" class="sidebar-link">Suggested Structure</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>API Generation</span><!----></p><ul class="sidebar-group-items"><li><a href="/pages/apidocs/swagger.html" class="sidebar-link">Swagger</a></li><li><a href="/pages/apidocs/graphql.html" class="sidebar-link">GraphQL</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Debugging</span><!----></p><ul class="sidebar-group-items"><li><a href="/pages/debugging/metrics.html" class="sidebar-link">Metrics</a></li><li><a href="/pages/debugging/logging.html" class="sidebar-link">Application Logs</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Further Reading</span><!----></p><ul class="sidebar-group-items"><li><a href="/pages/further_reading/migrate_from_express.html" class="sidebar-link">Migrate from Express</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="relationships"><a href="#relationships" aria-hidden="true" class="header-anchor">#</a> Relationships</h1><h3 id="foreign-key-relations"><a href="#foreign-key-relations" aria-hidden="true" class="header-anchor">#</a> Foreign Key Relations</h3><p>We want to be able to back our resources in any datastore we like, in any system we like. This means we can't rely on any database layer relationships to join resources.</p><h4 id="problem-supporting-back-links"><a href="#problem-supporting-back-links" aria-hidden="true" class="header-anchor">#</a> Problem: supporting back-links</h4><p>In other words, each resource would maintain its own linkage.</p><p>Consider these resources:</p><div class="language- extra-class"><pre class="language-text"><code>Bookings have people:
  &quot;HPABCDE&quot;: {
    owner: &quot;Dave&quot;
  }

People have Bookings:
  &quot;Dave&quot;: {
    bookings: [ &quot;HPABCDE&quot; ]
  }
  &quot;Fred&quot;: {
    bookings: [ ]
  }
</code></pre></div><p>If I were to update the owner of HPABCDE to &quot;Fred&quot;:
PATCH -&gt; /bookings/HPABCDE/relationships/owner
then the dataset would look like this:</p><div class="language- extra-class"><pre class="language-text"><code>Bookings have people:
  &quot;HPABCDE&quot;: {
    owner: &quot;Fred&quot;
  }

People have Bookings:
  &quot;Dave&quot;: {
    bookings: [ &quot;HPABCDE&quot; ]
  }
  &quot;Fred&quot;: {
    bookings: [ ]
  }
</code></pre></div><p>Notice the reverse linkage between bookings and people is now broken. We could get around this by automatically forcing other update requests:</p><div class="language- extra-class"><pre class="language-text"><code>PATCH -&gt; /bookings/HPABCDE/relationships/owner
---- becomes
PATCH -&gt; /bookings/HPABCDE/relationships/owner
PATCH -&gt; /people/Dave/relationships/bookings
PATCH -&gt; /people/Fred/relationships/bookings
</code></pre></div><p>All 3x requests combined will produce the desired end linkage:</p><div class="language- extra-class"><pre class="language-text"><code>Bookings have people:
  &quot;HPABCDE&quot;: {
    owner: &quot;Dave&quot;
  }

People have Bookings:
  &quot;Dave&quot;: {
    bookings: [ ]
  }
  &quot;Fred&quot;: {
    bookings: [ &quot;HPABCDE&quot; ]
  }
</code></pre></div><p>The number of requests vary on the relationship (1-1, 1-many, many-many, many-1).</p><p>Consider now if one of the 3 updates fails - we need to rollback the other 2. We now have to do all of this:</p><div class="language- extra-class"><pre class="language-text"><code>PATCH -&gt; /bookings/HPABCDE/relationships/owner
---- becomes
GET -&gt; /bookings/HPABCDE/relationships/owner
GET -&gt; /people/Dave/relationships/bookings
GET -&gt; /people/Fred/relationships/bookings
PATCH -&gt; /bookings/HPABCDE/relationships/owner
PATCH -&gt; /people/Dave/relationships/bookings
PATCH -&gt; /people/Fred/relationships/bookings
[if one fails...]
PATCH -&gt; /bookings/HPABCDE/relationships/owner
PATCH -&gt; /people/Dave/relationships/bookings
</code></pre></div><p>There's also now a racehazard whereby two people try to update the same resource and mess up the relations. This is solvable by passing in a checksum to the PATCH requests, allowing us to identify if a resource has been remotely modified. The checksum would need to be returned as a part of the JSON:API formatted response, alongside &quot;id&quot; and &quot;type&quot;.</p><p>In a nutshell - all of the above is a terrible idea.</p><h4 id="solution-we-only-support-forward-links"><a href="#solution-we-only-support-forward-links" aria-hidden="true" class="header-anchor">#</a> Solution: we only support forward-links</h4><p>This:</p><div class="language- extra-class"><pre class="language-text"><code>Bookings have people:
  &quot;HPABCDE&quot;: {
    owner: &quot;Dave&quot;
  }

People have Bookings:
  &quot;Dave&quot;: {
    bookings: [ ]
  }
  &quot;Fred&quot;: {
    bookings: [ &quot;HPABCDE&quot; ]
  }
</code></pre></div><p>becomes:</p><div class="language- extra-class"><pre class="language-text"><code>Bookings have people:
  &quot;HPABCDE&quot;: {
    owner: &quot;Dave&quot;
  }

People don't know about their Bookings:
  &quot;Dave&quot;: {

  }
  &quot;Fred&quot;: {

  }
</code></pre></div><p>HOWEVER, we still want to maintain the reverse linkage, so we'll still offer up a linkage like this:</p><div class="language- extra-class"><pre class="language-text"><code>/rest/people/26aa8a92-2845-4e40-999f-1fa006ec8c63/bookings
</code></pre></div><p>although under the hood, we'll re-map it to something like this:</p><div class="language- extra-class"><pre class="language-text"><code>/rest/bookings/relationships/?customer=26aa8a92-2845-4e40-999f-1fa006ec8c63
</code></pre></div><p>and query for <code>bookings</code> where <code>customer=?</code>.</p><p>The main gotcha here is this in this situation:</p><div class="language- extra-class"><pre class="language-text"><code>  Bookings maintain links to People
  People maintain links to Trips
  Trips maintain links to Bookings
</code></pre></div><p>Looking up a person creates a reverse lookup against Bookings, creating a reverse lookup against Trips, causing a reverse lookup against People, creating a reverse lookup against....</p><p>Our solution here is to add <code>meta</code> blocks to relationships to inform the consumer what kind of linkage they are looking at, and to not provide foreign keys directly:</p><div class="language-json extra-class"><pre class="language-json"><code>relationships<span class="token operator">:</span> <span class="token punctuation">{</span>
  author<span class="token operator">:</span> <span class="token punctuation">{</span>
    meta<span class="token operator">:</span> <span class="token punctuation">{</span>
      relation<span class="token operator">:</span> <span class="token string">&quot;primary&quot;</span><span class="token punctuation">,</span>
      readOnly<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    links<span class="token operator">:</span> <span class="token punctuation">{</span>
      // get information about the linkage - list of ids and types
      self<span class="token operator">:</span> <span class="token string">&quot;http://localhost:16006/rest/comments/6b017640-827c-4d50-8dcc-79d766abb408/relationships/author&quot;</span><span class="token punctuation">,</span>
      // get full details of all linked resources
      related<span class="token operator">:</span> <span class="token string">&quot;http://localhost:16006/rest/comments/6b017640-827c-4d50-8dcc-79d766abb408/author&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&quot;people&quot;</span><span class="token punctuation">,</span>
      id<span class="token operator">:</span> <span class="token string">&quot;ad3aa89e-9c5b-4ac9-a652-6670f9f27587&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  article<span class="token operator">:</span> <span class="token punctuation">{</span>
    meta<span class="token operator">:</span> <span class="token punctuation">{</span>
      relation<span class="token operator">:</span> <span class="token string">&quot;foreign&quot;</span><span class="token punctuation">,</span>
      belongsTo<span class="token operator">:</span> <span class="token string">&quot;articles&quot;</span><span class="token punctuation">,</span>
      as<span class="token operator">:</span> <span class="token string">&quot;author&quot;</span><span class="token punctuation">,</span>
      readOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      many<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    links<span class="token operator">:</span> <span class="token punctuation">{</span>
      // get information about the linkage - list of ids and types
      self<span class="token operator">:</span> <span class="token string">&quot;http://localhost:16006/rest/articles/relationships/?comments=6b017640-827c-4d50-8dcc-79d766abb408&quot;</span><span class="token punctuation">,</span>
      // get full details of all linked resources (perform a search against the foreign key<span class="token punctuation">)</span>
      related<span class="token operator">:</span> <span class="token string">&quot;http://localhost:16006/rest/articles/?filter[comments]=6b017640-827c-4d50-8dcc-79d766abb408&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/jagql/jagql.github.io/edit/master/pages/project_setup/relationships.md" target="_blank" rel="noopener noreferrer">Improve this documentation</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/pages/project_setup/resources.html" class="prev">
          Resources
        </a></span><span class="next"><a href="/pages/project_setup/handlers.html">
          Handlers
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/16.a88f0362.js" defer></script><script src="/assets/js/app.1082b650.js" defer></script>
  </body>
</html>
